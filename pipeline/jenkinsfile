@Library('mlops-shared-library') _

pipeline {
    agent any

    parameters {
        string(name: "MODEL_NAME", defaultValue: 'diabetes-prediction', description: 'Name of the model')
        string(name: "DOCKER_REGISTRY", defaultValue: 'docker.io', description: 'Docker registry URL')
        string(name: "DOCKER_CREDENTIALS_ID", defaultValue: 'docker-registry', description: 'Credentials ID for Docker registry')
        booleanParam(name: "HAS_API", defaultValue: true, description: 'Does the model have an API?')
        booleanParam(name: "USE_HELM", defaultValue: false, description: 'Use Helm for deployment?')
        booleanParam(name: "USE_MLFLOW", defaultValue: false, description: 'Use MLflow for tracking?')
        booleanParam(name: "RUN_LOAD_TESTS", defaultValue: false, description: 'Run load tests?')
        booleanParam(name: "SKIP_TESTS", defaultValue: false, description: 'Skip testing stages?')
        choice(name: "ENVIRONMENT", choices: ['dev', 'staging', 'prod'], description: 'Deployment environment')
    }

    environment {
        config = [
            // Basic and Common Variables
            modelName: "${params.MODEL_NAME}",
            dockerRegistry: "${params.DOCKER_REGISTRY}",
            dockerCredentialsId: "${params.DOCKER_CREDENTIALS_ID}",
            dockerImage: "${env.DOCKER_REGISTRY}/${env.MODEL_NAME}:${env.BUILD_NUMBER}",
            dockerImageLatest: "${env.DOCKER_REGISTRY}/${env.MODEL_NAME}:latest",
            helmChartPath: "./deployment/helm",
            helmChartName: "${params.MODEL_NAME}-chart",
            dockerRegistry: 'docker.io',

            // Feature Flags
            hasApi: true,
            useHelm: "${params.USE_HELM}",
            useMlflow: "${params.USE_MLFLOW}",
            runLoadTests: false,
            runSecurityTests: true,
            runSmokeTests: true,
            autoRollback: true,
            
            // Monitoring
            enablePrometheus: true,
            enableGrafana: false,
            enableAlerting: false,
            
            // Notifications
            emailRecipients: 'manhhung20033004@gmail.com'
        ]
    }

    stages {
        stage("Data Validation") {
            steps {
                script {
                    dataValidation(config)
                }
            }
        }
        stage("Model training") {
            steps {
                script {
                    modelTraining(config)
                }
            }
        }
        stage("Model Validation"){
            steps {
                script {
                    modelValidation(config)
                }
            }
        }
        stage("Model Testing") {
            steps {
                script {
                    modelTesting(config)
                }
            }
        }
        stage("Model Packaging") {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'develop'
                }
            }
            steps {
                script {
                    modelPackaging(config)
                }
            }
        }
        stage("Model Deployment") {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                }
            }
            steps {
                script {
                    modelDeployment(config)
                }
            }
        }
        stage("Model Monitoring Setup") {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                }
            }
            steps {
                script {
                    modelMonitoringSetup(config)
                }
            }
        }
        stage("Send Notifications") {
            steps {
                script {
                    sendNotifications(config)
                }
            }
        }
    }
}